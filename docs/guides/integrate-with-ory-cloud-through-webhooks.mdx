---
id: integrate-with-ory-cloud-through-webhooks
title: Use webhooks to integrate with The Ory Network
sidebar_label: Webhooks
---

Thanks to webhooks, you can easily integrate with external services, for example ERP or CRM. Ory Identities (Ory Kratos) allows
you to tie the execution of custom calls to external systems to self-service user flows.

:::tip

Self-service user flows are actions that the users of a system perform on their own, without the need of administrative
intervention.

:::

By triggering custom logic at specific points of self-service user flows, you can custom-tailor your users' customer experience,
trigger usage data collection to learn more about how your system is used, and more.

Follow these steps to add a webhook that enables integration with Mailchimp. With this integration in place, the system sends a
welcome email message to all newly registered users.

1. Get the Ory Identities config with Ory CLI:

   ```shell
   ## List all available projects
   ory list projects

   ## Get config
   ory get identity-config <project-id> --format yaml > identity-config.yaml
   ```

2. Create a request body Jsonnet snippet and encode it with Base64:

   ```jsonnet title="Mailchimp request body"
   function(ctx) {
     key: "<Your-Api-Key>", // Mailchimp requires passing the API key in request body.
     message: {
       from_email: "hello@welcomemail.com",
       subject: "Hello from Ory",
       text: "Welcome to Ory! Have fun and happy hacking!",
       to: [
         {
           email: ctx.identity.verifiable_addresses[0].value,
           type: "to"
         }
       ]
     }
   }
   ```

3. Add the webhook configuration to the downloaded Ory Identities (Ory Kratos) configuration file.

   ```yaml title="identity-config.yaml"
   selfservice:
     flows:
       registration: # Defines for which flow triggers the hook.
         after: # Defines the point at which the hook runs.
           password: # When method is defined, the hook is triggered only for this particular method and flow.
             hooks:
               - hook: web_hook
                 config:
                   url: https://mandrillapp.com/api/1.0/messages/send
                   method: POST
                   # Encode the Jsonnet with Base64 and add the encoded string to 'body'.
                   body: base64://ENCODED_JSONNET
   ```

4. Update the Ory Identities configuration using the file you worked with:

   ```shell
   ory update identity-config <project-id> --file updated_config.yaml
   ```

:::tip

Read [this document](../kratos/hooks/configure-hooks) to learn more about hooks in The Ory Network.

:::


---


### Webhooks

To configure webhooks, use this pattern:

````mdx-code-block
<Tabs groupId="wherehosted">
  <TabItem value="cloud" label="The Ory Network" default>

```yaml
selfservice:
  flows:
    login:
      before:
        hooks:
          - hook: web_hook # To use webhooks, you must set 'hook' to 'web_hook'
            config:
              url: https://test.hook.site.sh/before_login_hook # Webhook URL.
              method: POST # HTTP method used to send request to the webhook URL.
              body: base64://ENCODED_JSONNET # Encoded Jsonnet template used to render payload.
              # Ignored when using an HTTP method that doesn't allow sending body. OPTIONAL
              can_interrupt: true # Defines if the webhook can interrupt the flow. Boolean. OPTIONAL
              auth:
                type: # Can be one of 'basic_auth' or 'api_key'
                config: # Additional auth config for the hook. Read next section for details.
```

| Setting | Mandatory | Description
| :------ | :-------: | :--------- |
| `url`   | Yes | URL called by the webhook. |
| `method`| Yes | HTTP method used to send a request to the webhook URL. |
| `body`  | No | Base64-encoded Jsonnet template used to render the payload. Ignored when using an HTTP method that doesn't allow sending body.|
| `can_interrupt`  | No | Defines if the webhook can interrupt the flow. |
| `auth`  | No | Webhook authentication mechanism configuration. |

  </TabItem>
  <TabItem value="selfhosted" label="Self-Hosted Ory Kratos Config" default>

```yaml
selfservice:
  flows:
    login:
      before:
        hooks:
          - hook: web_hook # To use webhooks, you must set 'hook' to 'web_hook'
            config:
              url: https://test.hook.site.sh/before_login_hook # Webhook URL.
              method: POST # HTTP method used to send request to the webhook URL.
              body: file:///path/of/my/jsonnet/file # Jsonnet template URI used to render payload.
              # Ignored when using an HTTP method that doesn't allow sending body. OPTIONAL
              can_interrupt: true # Defines if the webhook can interrupt the flow. Boolean. OPTIONAL
              auth:
                type: # Can be one of 'basic_auth' or 'api_key'
                config: # Additional auth config for the hook. Read next section for details.
```

| Setting | Mandatory | Description
| :------ | :-------: | :--------- |
| `url`   | Yes | URL called by the webhook. |
| `method`| Yes | HTTP method used to send a request to the webhook URL. |
| `body`  | No | Jsonnet template URI used to render payload. Use `file://path/to/body.jsonnet` when referring to local files. Ignored when using an HTTP method that doesn't allow sending body.|
| `can_interrupt`  | No | Defines if the webhook can interrupt the flow. |
| `auth`  | No | Webhook authentication mechanism configuration. |


  </TabItem>
</Tabs>
````

:::info

Webhooks can't control the execution of the flow by patching/updating particular properties of flow-specific objects on webhook
completion.

The execution of the flow can be canceled if the call to the webhook endpoint fails either due to a network error or if the
endpoint returns an HTTP code `4xx` or `5xx` response.

:::

#### Request body

Webhooks bind the `flow`, as well as request headers (`request_headers`), request method (`request_method`), and the request URL
(`request_url`) of the flow into the Jsonnet template for all methods and execution paths (before and after). For the `after`
execution path of all flows, it binds the `identity` object into the Jsonnet template as well. These objects are available through
a `ctx` object.

To send `{ user_id: <some-id> }` in the request body, create the following the Jsonnet template:

```jsonnet
function(ctx) { user_id: ctx.identity.id }
```

#### Authentication and authorization in webhooks

For `auth` following mechanisms are supported:

- API key authentication. Type must be set to `api_key`. All properties are mandatory.

```yaml
- hook: web_hook
  # <other configuration keys>
  config:
    auth:
      type: api_key
      config:
        name: Authorization
        value: The-Value-of-My-Key
        in: header # alternatively "cookie"
  ```

- "Basic Authentication" type authentication. Type must be set to `basic_auth`. All properties are mandatory.

For `basic_auth` the config looks as follows:

```yaml
- hook: web_hook
  # <other configuration keys>
  config:
    auth:
      type: basic_auth
      config:
        user: My-User
        password: My-Pass-Value
  ```

#### Canceling webhooks

You can cancel configured webhooks and not make the defined request.

This can come in handy in testing. For example, by canceling a webhook, you prevent the test accounts created during testing from
being added to CRM.

To get this behavior, cancel the webhook by raising an error for all accounts with the `test-` name prefix:

```jsonnet
function(ctx)
if std.startsWith(ctx.identity.traits.email, "test-") then
  error "cancel"
else
  {
    user_id: ctx.identity.id
  }
```

:::info

Currently, jsonnet doesn't support regular expressions. Follow this issue to see if the feature has been implemented:
[google/go-jsonnet/409](https://github.com/google/go-jsonnet/issues/409).

:::

#### Non-blocking webhooks

Sometimes you need to interact with external systems without needing their response. For example, when a user signs up, a webhook
is that adds their email address to the newsletter is triggered.

If you decide that the system response that indicates if the process was successful is not critical for your setup, make the
webhook execution non-blocking to ignore whatever response is returned.

To do that, set `response.ignore` to `true` in the webhook config:

```yaml
- hook: web_hook
  config:
    # highlight-start
    response:
      ignore: true
    # highlight-end
```

#### Flow-interrupting webhooks

If you want the result of webhook execution to have the potential of blocking a self-service user flow, use the
`can_interrupt: true` setting in the config.

The external service called in the flow decides if it allows the flow to continue, or if it interrupts the flow. For example:

- For HTTP response codes `1xx`, `2xx`, and `3xx`, the flow is not interrupted.
- For HTTP response codes `4xx`, `5xx`, the external service interrupts the flow and returns a predefined payload.

Example payload:

```json
{
  "messages": [
    {
      "instance_ptr": "#/traits/foo/bar", # Indicates the field where there is an error.
      "messages": [
        {
          "id": 123, # Unique numeric ID of the error that helps the frontend to interpret this message.
          "text": "field must be longer than 12 characters",
          "type": "validation",
          "context": {
            "value": "short value"
          }
        }
      ]
    }
  ]
}
```

When using an `after` registration hook, you can define the specific point in the flow where this webhook is called:

- When the webhook can interrupt the flow (`can_interrupt: true`), the logic is called before the system creates a new identity.
- When the webhook can't interrupt the flow (`can_interrupt: false`), the logic is called after the system creates a new identity.

You can call a webhook before and after the system creates an identity. To do that, define two webhooks with different
`can_interrupt` values:

```yaml
flows:
  registration:
    after:
      password:
        hooks:
          - hook: web_hook
            config:
              can_interrupt: true
          - hook: web_hook
            config:
              can_interrupt: false
```

:::tip

Flow-interrupting webhooks work best if you give users meaningful information about the status of their flow. The best place to
trigger these hooks is `after` flows.

:::
