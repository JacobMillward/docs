---
id: segment
title: Segment Integration
sidebar_label: Segment
---

[Segment](https://www.segment.com) is a customer data platform that helps businesses unify their customer data from multiple sources into one centralized location. It provides a unified API for collecting, storing, and routing customer data to other tools, such as analytics and marketing platforms.

To integrate Segment with Ory Actions, you'll need to complete the following steps:

1. Create a Segment account and set up the necessary sources for your customer data.
1. Configure a destination for Ory Actions in the Segment Workspace.
1. Write down the Segment Write Key.
1. In your Ory Network project, set up an Ory Action trigger that will send data to the Segment destination whenever a specific event occurs, for example on successful registration.
1. Test the integration to ensure that data is being correctly routed from your Ory Actions application to Segment.

By integrating Segment with Ory Actions, you can easily collect and route customer data to other tools, helping you to gain a better understanding of your customers and make data-driven decisions.

## Sending `identify` to Segment

In the following example, we will set up an action which calls [Segment's Identify API](https://segment.com/docs/connections/spec/identify/) during registration to identify the user.

:::info

Unsure what JsonNet is? Read the [Ory Actions webhook guide](../../guides/integrate-with-ory-cloud-through-webhooks.mdx).

:::

First, we create a JsonNet file. It transforms the identity data from Ory to a format Segment understands:

```jsonnet title="./segment_identify.jsonnet"
function(ctx) {
  userId: ctx.identity.id,
  traits: {
    email: ctx.identity.traits.email,
    name: ctx.identity.traits.name,
    newsletterConsent: ctx.identity.traits.consent.newsletter,
  },
}
```

To use this JsonNet snippet, we need to encode it to base64 and save it to the clipboard:

```shell
cat segment_identify.jsonnet | base64 | pbcopy
```

Next, we define the Ory Action as a JSON Object

```json title="./webhook-action.json"
{
  "hook": "web_hook",
  "config": {
    "auth": {
      "type": "basic_auth",
      "config": {
        "user": "{YOUR_SEGMENT_WRITE_KEY}",
        "password": ""
      }
    },
    "url": "https://api.segment.io/v1/identify",
    "method": "POST",
    "body": "base64://{JSONNET_FROM_CLIPBOARD}"
  }
}
```

and replace the values. The result will look something like this:

```json title="webhook-action.json"
{
  "hook": "web_hook",
  "config": {
    "auth": {
      "type": "basic_auth",
      "config": {
        "user": "DcJ2eWJSCG8gw3njklgdLUHKA780456hjg",
        "password": ""
      }
    },
    "response": { "ignore": true },
    "url": "https://api.segment.io/v1/identify",
    "method": "POST",
    "body": "base64://CmZ1bmN0aW9uKGN0eCkgewogIHVzZXJJZDogY3R4LmlkZW50aXR5LmlkLAogIHRyYWl0czogewogICAgZW1haWw6IGN0eC5pZGVudGl0eS50cmFpdHMuZW1haWwsCiAgICBuYW1lOiBjdHguaWRlbnRpdHkudHJhaXRzLm5hbWUsCiAgICBuZXdzbGV0dGVyQ29uc2VudDogY3R4LmlkZW50aXR5LnRyYWl0cy5jb25zZW50Lm5ld3NsZXR0ZXIsCiAgfSwKfQo="
  }
}
```

The last step is to add this action to your Ory Network Project using the Ory CLI. Here, we trigger this webhook after successful registration:

```shell
ory patch identity-config {project.id} \
  --add "/selfservice/flows/registration/after/hooks/0=$(cat webhook-action.json)" \
  --format yaml
```

You may also trigger this webhook only when the user signs up with a password or social sign in:

```shell
ory patch identity-config {project.id} \
  --add "/selfservice/flows/registration/after/password/hooks/0=$(cat webhook-action.json)" \
  --format yaml
```
